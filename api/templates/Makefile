export SHELL = /bin/bash

.DEFAULT: help
.PHONY: test

DOCKER_PORT:={{=it.DOCKER_PORT}}
NODE_PORT:={{=it.NODE_PORT}}
DOCKER_REPOSITORY=utilitywarehouse/{{=it.name}}
DOCKER_CONTAINER_NAME={{=it.name}}

INSTALL:=$(shell type -p yarn || echo npm install)

help:
	@echo Available targets:
	@echo
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

bypass:
	@echo 'Bypass'

install: ## install project dependencies (including dev)
	$(INSTALL)

dev: ## run service for development
	NODE_ENV=development PORT=$(NODE_PORT) ./node_modules/.bin/nodemon -w src -w index.js --exec node -- index.js  | ./node_modules/.bin/bunyan -o short

# DOCKER INTEGRATION

docker-image: ## build docker image from current sources
	docker build -t $(DOCKER_REPOSITORY) .

# CIRCLE INTEGRATION - AUTOGENERATED
ci-docker-auth:
	docker login -e $(DOCKER_EMAIL) -u $(DOCKER_ID) -p $(DOCKER_PASSWORD)

ci-docker-build: ci-docker-auth ## run docker build in Circle
	docker build -t $(DOCKER_REPOSITORY):$(CIRCLE_SHA1) .
	docker tag $(DOCKER_REPOSITORY):$(CIRCLE_SHA1) $(DOCKER_REPOSITORY):latest
	docker push $(DOCKER_REPOSITORY)

ci-kubernetes-push: bypass
